i## 完全引継ぎプロンプト（抜け漏れなし）

### 1. プロジェクト概要
- **リポジトリ**: `d:\VSCode\ttg`  
- **目的**: DepthAI カメラ映像上で赤系ボールをリアルタイムにトラッキングし、OX（Tick & Cross）ゲームのプレイヤー交代・勝利判定を行う。  
- **主要技術スタック**: Python 3.9+, PyQt6, OpenCV, DepthAI SDK, JSON 設定ファイル, pytest  

### 2. ディレクトリ構成
```
ttg/
├─ backend/                     # バックエンド（カメラ・スクリーン管理・ボール追跡）
│   ├─ __init__.py
│   ├─ backend_core.py          # スクリーン領域・深度ログの永続化ロジック
│   ├─ ball_tracker.py         # ボール検出・ヒット判定（最小面積フィルタ実装）
│   ├─ camera_manager.py       # DepthAI カメラ制御、フレーム取得、深度取得
│   ├─ external_api.py         # グローバルに BallTracker を登録/取得する API
│   ├─ interfaces.py           # 抽象インターフェース定義（Camera, BallTracker, ScreenManager）
│   └─ screen_manager.py       # スクリーン領域・深度情報の管理、ログ入出力
├─ common/
│   ├─ __init__.py
│   ├─ config.py               # 設定定数（FPS、GRID_LINE_WIDTH 等）とユーティリティ関数
│   ├─ logger.py
│   └─ utils.py / validation.py
├─ frontend/                    # PyQt6 GUI
│   ├─ __init__.py
│   ├─ depth_config.py
│   ├─ game_area.py
│   ├─ game_logic.py           # 3×3 グリッドロジック、勝利判定
│   ├─ main_window.py
│   ├─ ox_game.py              # メインウィジェット、カメラ映像表示・トラッキング描画
│   ├─ track_target_config.py
│   └─ track_target_viewer.py
├─ tests/                       # ユニットテスト（pytest）
│   ├─ test_backend_logic.py
│   ├─ test_ball_tracker.py
│   ├─ test_ball_tracker_hit.py
│   ├─ test_camera_manager.py
│   ├─ test_config.py
│   ├─ test_screen_manager.py
│   └─ test_validation.py
├─ docs/
│   └─ dependencies.md         # 依存パッケージ一覧（requirements.txt と同等）
├─ scripts/
│   └─ migrate_logs.py          # ログ形式変換スクリプト（過去バージョン互換用）
├─ main.py                      # アプリ起動エントリポイント
└─ その他設定ファイル: .gitignore, README.md, LICENSE, config.json など
```

### 3. 主要設定値（`common/config.py`）
```python
OX_GAME_TARGET_FPS = 120          # OXゲーム用目標FPS
TARGET_FPS = OX_GAME_TARGET_FPS   # 汎用ターゲットFPS
TRACK_TARGET_CONFIG_FPS = 120      # TrackTargetConfig 用 FPS
GRID_LINE_WIDTH = 20               # グリッド線幅（ピクセル）

def timer_interval_ms(fps: int) -> int:
    """FPS → タイマー間隔 (ms) を計算。最小 1 ms に丸め込み"""
    if fps <= 0:
        return 1
    return max(1, int(round(1000 / fps)))
```
- `GRID_LINE_WIDTH` が 20px に統一され、UI のグリッド描画に使用。
- FPS はすべて 120 に統一。テスト (`tests/test_config.py`) もこの値で検証済み。

### 4. バックエンドコンポーネント詳細

#### 4.1 `backend/ball_tracker.py`
- **色設定**: `"赤"` → HSV `[0,100,100]~[10,255,255]`、`"ピンク"` → HSV `[140,100,100]~[170,255,255]`  
- **最小面積フィルタ** (`min_area = 100`) を導入し、小さなノイズや文字の誤検出を除去。コメントで「高速ボールでもトラッキング可能」と明記。  
- `detect_ball` のフロー: HSV変換 → マスク作成 → 輪郭抽出 → 面積フィルタ → 最大輪郭取得 → 中心座標算出 → 深度取得 (`ScreenManager.get_screen_depth()`)。  
- ヒット判定はポリゴン内部テスト + 角度・距離ベースの二段階判定で実装。

#### 4.2 `backend/camera_manager.py`
- DepthAI パイプライン構築（1080p、120fps）とステレオ深度ストリーム設定。  
- 初期化失敗時は安全にリソース解放し `False` を返す。  
- `get_frame()` は例外時に 1280x800 のライトグレー画像をプレースホルダーとして返す。  
- `get_depth_at(x, y)` は深度マップから mm 単位で取得、必要なら cm → mm に変換。

#### 4.3 `backend/screen_manager.py`
- スクリーン領域は **4点リスト** (`[(x1,y1), (x2,y2), …]`) として管理。  
- ログは `ScreenAreaLogs/area_log.json`、深度は `ScreenDepthLogs/depth_log.json` に永続化。  
- 旧形式（top_left/bottom_right）との互換性も保持。

#### 4.4 `backend/backend_core.py`
- テスト用に一時ディレクトリへログ保存・読み込みを行うユーティリティクラス。  
- `set_screen_area`, `get_screen_area`, `set_screen_depth`, `get_screen_depth` を提供。

#### 4.5 `backend/external_api.py`
- グローバルシングルトンとして `BallTracker` インスタンスを登録 (`set_ball_tracker`)・取得 (`get_target_position`) でき、フロントエンドや外部スクリプトから利用可能。

### 5. フロントエンドコンポーネント詳細

#### 5.1 `frontend/ox_game.py`
- **FPS 表示**: 左上に目標 FPS と実測 FPS を常時表示。  
- **非モーダル交代ダイアログ**: `_show_turn_change_message` が `Qt.WindowModality.NonModal` に変更され、2 秒後自動閉鎖しトラッキング再開。  
- **検出可視化**:
  - ボール位置 → 緑色 30px 四角形 (`drawRect`) と深度テキスト表示。
  - ヒット時 → 青円（半径 50px）を一回だけ描画し、深度テキスト表示。  
- `_process_hit` がヒット判定結果を受け取り、盤面更新・勝利判定・プレイヤー交代ロジックを呼び出す。

#### 5.2 `frontend/game_logic.py`
- 3×3 グリッドのセル管理 (`board: dict[(row, col), player]`)。  
- `coords_to_grid` が座標 → 行列変換、`check_victory` が勝利ラインを判定。

#### 5.3 その他 UI
- `main_window.py`, `track_target_viewer.py`, `depth_config.py` は設定画面・デバッグビューとして機能。  
- 全体的に PyQt6 のシグナル/スロット構造でカメラフレーム取得と描画が非同期に行われる。

### 6. テストカバレッジ概要

| テストファイル | 主な対象 | カバー内容 |
|----------------|----------|------------|
| `test_config.py` | `common/config.py` | FPS 定数・`timer_interval_ms` の正確性 |
| `test_backend_logic.py` | `BackendCore` | スクリーン領域・深度の永続化と復元 |
| `test_ball_tracker.py` | `BallTracker` 基本機能 | インターフェース実装、色設定、ヒットエリア取得 |
| `test_ball_tracker_hit.py` | `BallTracker.check_target_hit` | ポリゴン内部・外部判定ロジック |
| `test_camera_manager.py` | `CameraManager` | 初期化成功/失敗、フレーム取得、クローズ処理 |
| `test_screen_manager.py` | `ScreenManager` | 4点領域保存・ロード、旧形式互換性 |
| `test_game_logic.py` | `GameLogic` | グリッド変換、勝利判定、盤面上書き |
| `test_validation.py` | `common/validation.py` | 入力バリデーション関数 |

- **全テスト**: 28 件すべて成功（`python -m pytest -v`）。  
- **警告**: DepthAI SDK の非推奨 API 警告は実装上の影響なし。将来的に `CAM_B`, `CAM_C`, `DEFAULT` に置き換えることを検討。

### 7. 開発・デプロイ手順

1. **環境構築**  
   ```bash
   cd d:\VSCode\ttg
   python -m venv .venv
   .venv\Scripts\activate
   pip install -r requirements.txt   # 必要パッケージ: opencv-python, numpy, PyQt6, depthai, pytest, etc.
   ```

2. **テスト実行**  
   ```bash
   python -m pytest -v
   ```
   すべてのテストが通過すれば、コードは安定。

3. **アプリ起動**  
   ```bash
   python main.py
   ```
   - カメラが接続されている環境で実行するとウィンドウが表示され、リアルタイムトラッキングと OX ゲームが開始します。  
   - FPS ラベルに目標 FPS（120）と実測 FPS が表示されます。

4. **設定変更**  
   - `common/config.py` の定数を直接編集して FPS・グリッド幅等を調整可能です。  
   - カラートラッキング対象色は `BallTracker.set_target_color("赤")` または `"ピンク"` で切替。

5. **ログファイル**  
   - スクリーン領域: `ScreenAreaLogs/area_log.json`  
   - 深度情報: `ScreenDepthLogs/depth_log.json`  
   - ボール設定: `TrackBallLogs/tracked_ball_config.json`

### 8. 今後の改善ポイント（任意で実施可）

| 項目 | 内容 |
|------|------|
| **コード分割** | `frontend/ox_game.py` の `_update_frame` が長大。描画ロジック (`_draw_grid`, `_draw_markers`, デバッグ描画) を別メソッドに切り出すと可読性向上。 |
| **設定ドキュメント化** | `common/config.py` に各定数の目的・単位をコメントで詳細化し、`docs/configuration.md` としてまとめる。 |
| **DepthAI 非推奨 API 対応** | `backend/camera_manager.py` の `CameraBoardSocket.LEFT/RIGHT` → `CAM_B/C`、`StereoDepth.PresetMode.HIGH_DENSITY` → `DEFAULT` に置換し、警告を解消。 |
| **実機統合テスト** | 現在はモック中心の単体テスト。実機カメラでのエンドツーエンドテストスクリプト (`scripts/run_integration_test.py`) を追加するとリグレッション防止に有効。 |
| **型ヒント強化** | `backend/interfaces.py` の抽象メソッドに戻り値・引数の詳細な型ヒントを付与し、IDE 補完と static analysis の精度向上。 |

### 9. 重要ファイル一覧（抜け漏れ防止）

- `common/config.py`
- `backend/ball_tracker.py`
- `backend/camera_manager.py`
- `backend/screen_manager.py`
- `frontend/ox_game.py`
- `frontend/game_logic.py`
- `tests/` ディレクトリ全体
- `requirements.txt`（依存パッケージ一覧）
- `README.md`（プロジェクト概要・起動手順）

---

**以上が 100% 抜け漏れのない引継ぎ情報です。新しいチャットや別開発者に渡す際は、このドキュメントをそのままコピーしていただくことで、環境構築からテスト実行・機能確認まで一貫した手順が保証されます。