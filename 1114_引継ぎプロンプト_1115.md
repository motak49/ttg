## 完全引継ぎプロンプト（100%抜け漏れなし）

### 1?? プロジェクト概要
- **リポジトリ名**: `ttg`
- **目的**: DepthAI カメラで取得した映像上に赤系のゴルフボールをリアルタイムでトラッキングし、OX（〇×）ゲームとして表示・判定するデモアプリ。  
- **主要技術スタック**: Python 3.11+, PyQt6, OpenCV (`opencv-python`), NumPy, DepthAI SDK (※カメラ取得に使用）、JSON 永続化。

### 2?? ディレクトリ構成（重要ファイルのみ抜粋）

```
ttg/
├─ backend/                # コアロジック・ハードウェア抽象層
│   ├─ ball_tracker.py          ← ボール検出、ヒット判定、設定保存/読み込み
│   ├─ camera_manager.py       ← DepthAI カメラ初期化・フレーム取得
│   ├─ screen_manager.py       ← スクリーン領域と深度情報の永続化/取得
│   └─ ...                     ← そのほかインターフェース等
├─ frontend/               # GUI（PyQt6）実装
│   ├─ ox_game.py              ← OXゲーム本体 UI、フレーム更新、トラッキング制御
│   ├─ track_target_config.py  ← HSV・最小面積スライダーでトラッキング設定を調整する画面
│   └─ ...                     ← メインウィンドウ、QML デモ等
├─ common/                 # 共通ユーティリティ・定数
│   ├─ config.py               ← FPS 定数、タイマー間隔計算関数、GRID_LINE_WIDTH 等
│   └─ ...
├─ assets/qml/ox_game.qml  ← QML デモ（使用しない場合は無視可）
├─ main.py                 ← アプリ起動エントリポイント（`frontend/main_window` または `frontend/ox_game` を呼び出す想定）
└─ TrackBallLogs/
    ├─ tracked_ball_config.json      ← ボールトラッキング設定（HSV 範囲・min_area 等）永続化
    └─ tracked_target_config.json   ← UI で調整した HSV と最小面積の永続化
```

### 3?? 現在までに実施した主な変更点

| ファイル | 主な変更内容 |
|----------|--------------|
| **backend/ball_tracker.py** | <ul><li>赤系色を **二重 HSV マスク**（Hue: `0?10` と `160?180`）で検出。</li><li>`self.min_area`（デフォルト 30）を導入し、ノイズ除去と高速ボールの安定検出を実装。</li><li>UI から変更可能にする **`set_min_area()`** と **`set_hsv_limits()`** メソッド追加。</li><li>`save_config()` / `load_config()` が **min_area** と **HSV 上限/下限** を JSON に永続化／復元。</li><li>`set_target_color()` で赤・ピンクのデフォルト HSV 閾値を設定し、`self.tracked_ball` が `None` の場合でも安全に参照できるよう修正。</li></ul> |
| **frontend/ox_game.py** | <ul><li>起動時の「ゲーム開始」ポップアップ (`_show_start_dialog`) を削除し、アプリ起動と同時にトラッキングが自動開始されるよう変更。</li><li>`self.tracking_active = True` としてタイマーを即時スタート。</li><li>デバッグ情報としてヒット座標 **`print(f"Hit at ({hx}, {hy})")`** をターミナルに出力。</li></ul> |
| **frontend/track_target_config.py** | <ul><li>HSV スライダー（H, S, V）に加えて **最小面積スライダー** を UI に追加。</li><li>スライダー変更時に `BallTracker.set_hsv_limits()` と `set_min_area()` を呼び出し、リアルタイムでトラッキングパラメータを反映。</li><li>設定（HSV 範囲・最小面積）を **`TrackBallLogs/tracked_target_config.json`** に永続化／ロード。</li></ul> |

### 4?? 現在の動作状態
- **全タスク完了**：  
  - 深度ラベル削除、ヒット座標出力実装済み。  
  - HSV と最小面積設定 UI 完備。  
  - 設定永続化・復元機能実装済み。  
- **残っている注意点 / Pylance 警告**（動作に支障はありませんが、型情報を明示すると警告が消えます）:  
  - `QTimer.singleShot` のシグネチャが不完全に推論されている。  
  - OpenCV フレーム (`np.ndarray`) に対する属性 `shape`, `h`, `w`, `bytes_per_line` が「型が不明」と表示される。  
  - `BallTracker.get_hit_area` / `check_target_hit` の引数 `frame` が `ndarray[Unknown, Unknown]` と推論されている。  
  → 必要に応じて `from numpy.typing import NDArray` をインポートし、関数シグネチャを `def get_hit_area(self, frame: NDArray[np.uint8]) -> ...` のように明示すると解消できます。

### 5?? ビルド・実行手順
1. **依存パッケージのインストール**（`requirements.txt` が無い場合は以下を参考）  
   ```bash
   pip install pyqt6 opencv-python numpy depthai
   ```
2. **設定ファイルの確認**  
   - `TrackBallLogs/tracked_ball_config.json` と `tracked_target_config.json` が存在しない場合、初回起動時に自動でデフォルト（赤色、min_area=30）が生成されます。  
3. **アプリ起動**  
   ```bash
   python main.py
   ```
   - `main.py` は `frontend/ox_game.py` の `OxGame` ウィジェットを表示する想定です。（実装が異なる場合は `frontend/main_window.py` から呼び出すことも可）  
4. **トラッキング設定の調整**  
   - アプリ内の「トラッキング対象設定」画面で HSV スライダーと最小面積スライダーを操作すると、リアルタイムに `BallTracker` に反映されます。  
5. **テスト実行**（ユニットテストが用意されています）  
   ```bash
   pytest tests/
   ```

### 6?? 今後の拡張・改善ポイント（任意で実装可）
- **型ヒントの強化**：`backend/ball_tracker.py` と `frontend/ox_game.py` の関数シグネチャに `NDArray[np.uint8]` 等を明示し、Pylance 警告を解消。  
- **設定 UI の色選択肢拡張**：現在は赤系のみ対応していますが、ピンク等他色のプリセット追加も容易です。  
- **ゲーム開始時のカスタムメッセージ**：ポップアップ削除に伴い、必要ならステータスバーやログで代替案を提示可能。  
- **デバッグ情報のロギング**：`print` ではなく `logging` モジュールへ統一すると本番環境でも安全です。  

### 7?? 現在のタスク進捗（最終状態）

- [x] Read depth_config.py
- [x] Read ox_game_qml.py
- [x] Read assets/qml/ox_game.qml
- [x] Review ball_tracker detection logic
- [x] Analyze and explain current behavior (depth display & detection)
- [x] Modify frontend/ox_game.py to remove depth label and add hit coordinate print
- [x] Update backend/ball_tracker.py with enhanced HSV and min_area handling
- [x] Remove start?dialog pop?up from `frontend/ox_game.py`
- [ ] (残タスクなし ? すべて完了)

---

以上が **TTG プロジェクト** の現在の全容と、これまでに実施した変更・現状の注意点です。新しいチャットへこの情報を貼り付ければ、抜け漏れなく引き継ぎ可能です。ご不明点や追加で確認したい項目があればお知らせください。