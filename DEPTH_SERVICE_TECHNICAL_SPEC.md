# ğŸ”¬ æ·±åº¦æ¸¬å®šã‚µãƒ¼ãƒ“ã‚¹ã®è©³ç´°æŠ€è¡“ä»•æ§˜æ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**ä½œæˆæ—¥**: 2025å¹´12æœˆ2æ—¥  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸ“‹ è¨ˆç”»æ®µéš

---

## 1ï¸âƒ£ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ OXã‚²ãƒ¼ãƒ      â”‚  â”‚ æ·±åº¦è¨­å®šUI   â”‚  â”‚ å°†æ¥ã®ã‚²ãƒ¼ãƒ  X  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                 â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å…±é€šã‚µãƒ¼ãƒ“ã‚¹å±¤ï¼ˆCommonï¼‰                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ DepthMeasurementService                          â”‚    â”‚
â”‚  â”‚  â”œâ”€ measure_at_rgb_coords(x, y) â†’ depth_m       â”‚    â”‚
â”‚  â”‚  â”œâ”€ measure_at_region(x1,y1,x2,y2) â†’ avg_depth â”‚    â”‚
â”‚  â”‚  â”œâ”€ is_valid_depth(depth) â†’ bool                â”‚    â”‚
â”‚  â”‚  â””â”€ get_confidence_score(x, y) â†’ score          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ DepthStorageService                              â”‚    â”‚
â”‚  â”‚  â”œâ”€ save(depth_m) â†’ bool                         â”‚    â”‚
â”‚  â”‚  â”œâ”€ load() â†’ Optional[float]                     â”‚    â”‚
â”‚  â”‚  â””â”€ clear() â†’ bool                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢æŠ½è±¡åŒ–å±¤ï¼ˆBackendï¼‰                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ CameraManager                                   â”‚     â”‚
â”‚  â”‚  â”œâ”€ get_depth_frame() â†’ ndarray[360,640]       â”‚     â”‚
â”‚  â”‚  â”œâ”€ get_depth_mm(x, y) â†’ float (mm)            â”‚     â”‚
â”‚  â”‚  â”œâ”€ _scale_rgb_to_depth_coords(x,y) â†’ (x',y') â”‚     â”‚
â”‚  â”‚  â””â”€ _get_nearby_depth_mm(x,y) â†’ float (mm)     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢å±¤ï¼ˆDepthAIï¼‰                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Stereo Depth Node                               â”‚     â”‚
â”‚  â”‚  â”œâ”€ è§£åƒåº¦: 640x360                             â”‚     â”‚
â”‚  â”‚  â”œâ”€ ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ: 30fpsï¼ˆæ¨å¥¨ï¼‰              â”‚     â”‚
â”‚  â”‚  â”œâ”€ ãƒ‡ãƒ¼ã‚¿å‹: uint16 (mm)                       â”‚     â”‚
â”‚  â”‚  â””â”€ æœ‰åŠ¹ç¯„å›²: 1000-5000mmï¼ˆå¯å¤‰ï¼‰              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ RGB Camera Node                                 â”‚     â”‚
â”‚  â”‚  â”œâ”€ è§£åƒåº¦: 1280x800                            â”‚     â”‚
â”‚  â”‚  â”œâ”€ ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ: 120fps                      â”‚     â”‚
â”‚  â”‚  â””â”€ ç›®çš„: UIè¡¨ç¤ºç”¨                              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2ï¸âƒ£ DepthMeasurementService ä»•æ§˜

### ã‚¯ãƒ©ã‚¹å®šç¾©

```python
class DepthMeasurementService:
    """
    Stereo Depthã‚’ä½¿ç”¨ã—ãŸæ·±åº¦æ¸¬å®šã‚µãƒ¼ãƒ“ã‚¹
    
    è²¬å‹™:
      - RGBåº§æ¨™ã‹ã‚‰ã®æ·±åº¦æ¸¬å®š
      - ç„¡åŠ¹å€¤ã®æ¤œå‡ºãƒ»è£œé–“
      - è¤‡æ•°ãƒã‚¤ãƒ³ãƒˆã®çµ±è¨ˆå‡¦ç†
      - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    """
```

### ãƒ¡ã‚½ãƒƒãƒ‰ä»•æ§˜

#### 1. `measure_at_rgb_coords(x: int, y: int) -> float`

**ç›®çš„**: å˜ä¸€ãƒ”ã‚¯ã‚»ãƒ«ã®æ·±åº¦æ¸¬å®š

**å…¥åŠ›**:
| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | èª¬æ˜ | ç¯„å›² |
|-----------|----|----|------|
| x | int | RGB ãƒ•ãƒ¬ãƒ¼ãƒ ã® X åº§æ¨™ | 0-1279 |
| y | int | RGB ãƒ•ãƒ¬ãƒ¼ãƒ ã® Y åº§æ¨™ | 0-799 |

**å‡ºåŠ›**:
```python
float  # æ·±åº¦ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
       # ç„¡åŠ¹ãªå ´åˆ: -1.0ï¼ˆã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ï¼‰
       # ä¾‹: 2.050 â†’ 2.050m
```

**å†…éƒ¨å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```
å…¥åŠ› (RGBåº§æ¨™ x, y)
  â†“
[åº§æ¨™å¤‰æ›] RGB(1280x800) â†’ Depth(640x360)
  â†“
[ãƒ•ãƒ¬ãƒ¼ãƒ å–å¾—] get_depth_frame() â†’ uint16 array
  â†“
[å€¤å–å¾—] depth_frame[y'][x'] â†’ mm
  â†“
[æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯] 0 < depth_mm < MAX_DEPTH
  â”œâ”€ YES â†’ mm â†’ m å¤‰æ› â†’ è¿”å´ âœ“
  â”œâ”€ NO  â†’ å‘¨è¾ºå€¤è£œé–“ã¸
  â†“
[å‘¨è¾ºå€¤è£œé–“] åŠå¾„10pxå†…ã§æœ€åˆã®æœ‰åŠ¹å€¤ã‚’æ¢ç´¢
  â”œâ”€ è¦‹ã¤ã‹ã£ãŸ â†’ è£œé–“å€¤ã‚’è¿”å´ âœ“
  â”œâ”€ è¦‹ã¤ã‹ã‚‰ãªã„ â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥å€¤ã‚’è¿”å´
  â†“
[ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°] è¨˜éŒ²ã—ã¦ -1.0 è¿”å´ âœ—
```

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
```python
# åº§æ¨™ãŒç¯„å›²å¤–ã®å ´åˆ
if not (0 <= x < 1280 and 0 <= y < 800):
    logging.warning(f"åº§æ¨™ãŒç¯„å›²å¤–: ({x}, {y})")
    return -1.0

# æ·±åº¦ãƒ•ãƒ¬ãƒ¼ãƒ ãŒ None ã®å ´åˆ
if depth_frame is None:
    logging.warning("æ·±åº¦ãƒ•ãƒ¬ãƒ¼ãƒ ãŒå–å¾—ã§ãã¾ã›ã‚“")
    return self._last_valid_depth if self._last_valid_depth else -1.0

# æ·±åº¦å€¤ãŒç„¡åŠ¹ã®å ´åˆ
if depth_mm <= 0 or depth_mm > MAX_DEPTH:
    # å‘¨è¾ºå€¤è£œé–“ã‚’è©¦ã¿ã‚‹
    interpolated = self._interpolate_nearby_depth(...)
    if interpolated > 0:
        return interpolated / 1000.0
    return -1.0
```

**ä½¿ç”¨ä¾‹**:
```python
service = DepthMeasurementService(camera_manager)

# ãƒœãƒ¼ãƒ«ä½ç½®ã®æ·±åº¦ã‚’å–å¾—
depth_m = service.measure_at_rgb_coords(785, 245)
if depth_m > 0:
    print(f"ãƒœãƒ¼ãƒ«æ·±åº¦: {depth_m:.2f}m")
else:
    print("æ·±åº¦æ¸¬å®šå¤±æ•—")
```

---

#### 2. `measure_at_region(x1: int, y1: int, x2: int, y2: int, method: str = "mean") -> float`

**ç›®çš„**: çŸ©å½¢é ˜åŸŸå†…ã®æ·±åº¦çµ±è¨ˆå‡¦ç†

**å…¥åŠ›**:
| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | èª¬æ˜ | ä¾‹ |
|-----------|----|----|------|
| x1, y1 | int | çŸ©å½¢ã®å·¦ä¸Šåº§æ¨™ï¼ˆRGBï¼‰ | (700, 200) |
| x2, y2 | int | çŸ©å½¢ã®å³ä¸‹åº§æ¨™ï¼ˆRGBï¼‰ | (870, 290) |
| method | str | é›†è¨ˆæ–¹æ³•: "mean" / "median" / "max" | "mean" |

**å‡ºåŠ›**:
```python
float  # çµ±è¨ˆå€¤ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
       # ç„¡åŠ¹ãªå ´åˆ: -1.0
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```
1. çŸ©å½¢å†…ã®å…¨ãƒ”ã‚¯ã‚»ãƒ«ã®æ·±åº¦ã‚’åé›†
2. ç„¡åŠ¹å€¤ï¼ˆâ‰¤0 æˆ–ã„ã¯ > MAXï¼‰ã‚’ãƒ•ã‚£ãƒ«ã‚¿
3. æŒ‡å®šã®çµ±è¨ˆé–¢æ•°ã§é›†è¨ˆ
   - "mean": å¹³å‡å€¤
   - "median": ä¸­å¤®å€¤ï¼ˆå¤–ã‚Œå€¤ã«å¼·ã„ï¼‰
   - "max": æœ€å¤§å€¤
4. æœ‰åŠ¹å€¤ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ -1.0
```

**ä½¿ç”¨ä¾‹**:
```python
# ãƒœãƒ¼ãƒ«ã®å‘¨è¾ºé ˜åŸŸï¼ˆ50x50pxï¼‰ã®å¹³å‡æ·±åº¦
depth_avg = service.measure_at_region(
    x1=760, y1=220,
    x2=810, y2=270,
    method="median"  # å¤–ã‚Œå€¤ã«å¼·ã„ä¸­å¤®å€¤
)
```

---

#### 3. `is_valid_depth(depth_m: float) -> bool`

**ç›®çš„**: æ·±åº¦å€¤ã®æœ‰åŠ¹æ€§ã‚’åˆ¤å®š

**ãƒ«ãƒ¼ãƒ«**:
```python
def is_valid_depth(self, depth_m: float) -> bool:
    return (
        depth_m > 0 and
        depth_m <= self.config.MAX_VALID_DEPTH_M and
        not math.isnan(depth_m)
    )
```

**æœ‰åŠ¹ç¯„å›²**:
| é …ç›® | å€¤ | èª¬æ˜ |
|------|-------|------|
| æœ€å°å€¤ | 0.5m | éå¸¸ã«è¿‘ã„ï¼ˆãƒã‚¤ã‚ºå¤šã„ï¼‰ |
| æ¨å¥¨æœ€å° | 1.0m | å®Ÿç”¨çš„ãªä¸‹é™ |
| æ¨å¥¨æœ€å¤§ | 5.0m | å®Ÿç”¨çš„ãªä¸Šé™ |
| çµ¶å¯¾æœ€å¤§ | 10.0m | ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ä¸Šé™ |

**ä½¿ç”¨ä¾‹**:
```python
depth_m = service.measure_at_rgb_coords(x, y)
if service.is_valid_depth(depth_m):
    print(f"æœ‰åŠ¹: {depth_m:.2f}m")
else:
    print("ç„¡åŠ¹ãªæ·±åº¦å€¤")
```

---

#### 4. `get_confidence_score(x: int, y: int) -> float`

**ç›®çš„**: æ·±åº¦å€¤ã®ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ã‚’å–å¾—

**è¿”ã‚Šå€¤**:
```python
float  # 0.0 ~ 1.0ï¼ˆ1.0ãŒæœ€ã‚‚ä¿¡é ¼åº¦é«˜ã„ï¼‰
```

**è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯**:
```python
def get_confidence_score(self, x: int, y: int) -> float:
    """
    æ·±åº¦å€¤ã®ä¿¡é ¼åº¦ã‚’ã‚¹ã‚³ã‚¢åŒ–
    
    è¦å› :
      1. å‘¨è¾ºãƒ”ã‚¯ã‚»ãƒ«ã¨ã®å¤‰å‹•ï¼ˆæ»‘ã‚‰ã‹ã•ï¼‰
      2. ãƒ•ãƒ¬ãƒ¼ãƒ å†…ã§ã®æœ‰åŠ¹ãƒ”ã‚¯ã‚»ãƒ«å¯†åº¦
      3. æ·±åº¦å€¤ãŒæ¨å¥¨ç¯„å›²å†…ã‹
    """
    # å®Ÿè£…äºˆå®š
    pass
```

---

### ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°

```python
class DepthMeasurementService:
    def __init__(self, camera_manager: CameraManager):
        self.camera_manager = camera_manager
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
        self._last_valid_depth: Optional[float] = None
        
        # çµ±è¨ˆæƒ…å ±
        self._measurement_history: List[float] = []  # ç›´è¿‘100å›
        
        # è¨­å®š
        self.config = DepthConfig(
            min_valid_mm=500,      # 0.5m
            max_valid_mm=10000,    # 10m
            interpolation_radius_px=10,
            measurement_timeout_ms=100
        )
```

---

## 3ï¸âƒ£ DepthStorageService ä»•æ§˜

### ã‚¯ãƒ©ã‚¹å®šç¾©

```python
class DepthStorageService:
    """
    æ·±åº¦å€¤ã®æ°¸ç¶šåŒ–ã‚µãƒ¼ãƒ“ã‚¹
    
    ä¿å­˜å…ˆ: ScreenDepthLogs/depth_log.json
    å½¢å¼: JSONï¼ˆå˜ä¸€å€¤ï¼‰
    """
```

### ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼

#### ä¿å­˜å½¢å¼ (JSON)
```json
{
  "screen_depth": 1.750,
  "timestamp": "2025-12-02T10:30:45.123456",
  "source": "user_measurement",
  "confidence": 0.95
}
```

#### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰èª¬æ˜
| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|----|----|
| screen_depth | float | æ·±åº¦å€¤ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰ |
| timestamp | ISO8601 | æ¸¬å®šæ™‚åˆ» |
| source | str | æ¸¬å®šå…ƒï¼ˆuser_measurement / auto_calibrationï¼‰ |
| confidence | float | ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ï¼ˆ0.0-1.0ï¼‰ |

### ãƒ¡ã‚½ãƒƒãƒ‰ä»•æ§˜

#### 1. `save(depth_m: float) -> bool`

```python
def save(self, depth_m: float) -> bool:
    """
    æ·±åº¦å€¤ã‚’ä¿å­˜
    
    Args:
        depth_m: æ·±åº¦ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
        
    Returns:
        bool: æˆåŠŸæ™‚ True
    """
    if not service.is_valid_depth(depth_m):
        logging.error(f"ç„¡åŠ¹ãªæ·±åº¦å€¤: {depth_m}")
        return False
    
    data = {
        "screen_depth": round(depth_m, 3),
        "timestamp": datetime.now().isoformat(),
        "source": "user_measurement",
        "confidence": self.get_confidence()
    }
    
    path = "ScreenDepthLogs/depth_log.json"
    os.makedirs(os.path.dirname(path), exist_ok=True)
    
    with open(path, 'w') as f:
        json.dump(data, f, indent=2)
    
    logging.info(f"æ·±åº¦ã‚’ä¿å­˜: {depth_m:.3f}m")
    return True
```

**ä½¿ç”¨ä¾‹**:
```python
storage = DepthStorageService()
if storage.save(2.050):
    print("ä¿å­˜æˆåŠŸ")
else:
    print("ä¿å­˜å¤±æ•—")
```

---

#### 2. `load() -> Optional[float]`

```python
def load(self) -> Optional[float]:
    """
    ä¿å­˜ã•ã‚ŒãŸæ·±åº¦å€¤ã‚’èª­ã¿è¾¼ã¿
    
    Returns:
        float: æ·±åº¦ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
        None: ãƒ•ã‚¡ã‚¤ãƒ«ãªã—æˆ–ã„ã¯ã‚¨ãƒ©ãƒ¼
    """
    path = "ScreenDepthLogs/depth_log.json"
    if not os.path.exists(path):
        logging.debug("æ·±åº¦ãƒ­ã‚°ãŒå­˜åœ¨ã—ã¾ã›ã‚“")
        return None
    
    try:
        with open(path, 'r') as f:
            data = json.load(f)
            return float(data.get("screen_depth", 0.0))
    except Exception as e:
        logging.error(f"æ·±åº¦èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
        return None
```

**ä½¿ç”¨ä¾‹**:
```python
storage = DepthStorageService()
depth = storage.load()
if depth:
    print(f"ä¿å­˜å€¤: {depth}m")
else:
    print("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãªã—")
```

---

#### 3. `clear() -> bool`

```python
def clear(self) -> bool:
    """
    ä¿å­˜ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ï¼‰
    
    Returns:
        bool: æˆåŠŸæ™‚ True
    """
    path = "ScreenDepthLogs/depth_log.json"
    try:
        if os.path.exists(path):
            os.remove(path)
        logging.info("æ·±åº¦è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ")
        return True
    except Exception as e:
        logging.error(f"ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼: {e}")
        return False
```

---

## 4ï¸âƒ£ åº§æ¨™å¤‰æ›ã®è©³ç´°

### RGB â†” Depth åº§æ¨™ã®å¤‰æ›

#### ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µã‚¤ã‚º
```
RGB ãƒ•ãƒ¬ãƒ¼ãƒ :    1280 x 800
Depth ãƒ•ãƒ¬ãƒ¼ãƒ :   640 x 360
```

#### ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ä¿‚æ•°
```python
scale_x = 640 / 1280 = 0.5
scale_y = 360 / 800 = 0.45
```

#### å¤‰æ›å¼

**RGB â†’ Depth**:
```python
def rgb_to_depth_coords(x_rgb: int, y_rgb: int) -> tuple[int, int]:
    x_depth = int(x_rgb * 0.5)
    y_depth = int(y_rgb * 0.45)
    return (x_depth, y_depth)

# ä¾‹
rgb_to_depth_coords(1280, 800) â†’ (640, 360)  âœ“
rgb_to_depth_coords(640, 400)  â†’ (320, 180)  âœ“
```

**Depth â†’ RGB** (å‚è€ƒ):
```python
def depth_to_rgb_coords(x_depth: int, y_depth: int) -> tuple[int, int]:
    x_rgb = int(x_depth / 0.5)
    y_rgb = int(y_depth / 0.45)
    return (x_rgb, y_rgb)
```

#### è¦–è¦šçš„ãªå¯¾å¿œ

```
RGB ãƒ•ãƒ¬ãƒ¼ãƒ  (1280x800)          Depth ãƒ•ãƒ¬ãƒ¼ãƒ  (640x360)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  (0,0)                  â”‚      â”‚  (0,0)           â”‚
â”‚    â—                    â”‚      â”‚    â—             â”‚
â”‚  (640,400)              â”‚  â†’   â”‚  (320,180)       â”‚
â”‚      â—                  â”‚      â”‚    â—             â”‚
â”‚                 (1280,800)â”‚     â”‚          (640,360)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5ï¸âƒ£ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥

### 3å±¤é˜²å¾¡

```
Layer 1: å…¥åŠ›æ¤œè¨¼
  â”œâ”€ åº§æ¨™ç¯„å›²ãƒã‚§ãƒƒã‚¯
  â”œâ”€ æ·±åº¦å€¤ç¯„å›²ãƒã‚§ãƒƒã‚¯
  â””â”€ å‹ãƒã‚§ãƒƒã‚¯

Layer 2: è£œé–“ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  â”œâ”€ ç„¡åŠ¹å€¤ã®å ´åˆã¯å‘¨è¾ºå€¤è£œé–“
  â”œâ”€ è£œé–“å¤±æ•—æ™‚ã¯å‰å›ã®æœ‰åŠ¹å€¤ã‚’ä½¿ç”¨
  â””â”€ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼è¿”å´

Layer 3: ãƒ­ã‚°è¨˜éŒ²ãƒ»é€šçŸ¥
  â”œâ”€ WARNING: è£œé–“ãŒç™ºç”Ÿ
  â”œâ”€ ERROR: æ¸¬å®šå¤±æ•—
  â””â”€ DEBUG: åº§æ¨™å¤‰æ›ãªã©ã®è©³ç´°
```

### ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰

```python
# æˆ»ã‚Šå€¤ã§ã®è¡¨ç¾
-1.0   # æ¸¬å®šå¤±æ•—ï¼ˆå®Œå…¨ãªã‚¨ãƒ©ãƒ¼ï¼‰
0.0    # ç„¡åŠ¹å€¤ï¼ˆ0m = ç‰©ç†çš„ã«ä¸å¯èƒ½ï¼‰
NaN    # è¨ˆç®—ã‚¨ãƒ©ãƒ¼
```

### ãƒ­ã‚®ãƒ³ã‚°ãƒ¬ãƒ™ãƒ«

```python
logging.debug("[DepthMeasurement] RGB(640,400) â†’ Depth(320,180)")
logging.info("[DepthMeasurement] æ·±åº¦æ¸¬å®šæˆåŠŸ: 2.050m")
logging.warning("[DepthMeasurement] å‘¨è¾ºå€¤ã‹ã‚‰è£œé–“: 2.050m")
logging.error("[DepthMeasurement] æ·±åº¦ãƒ•ãƒ¬ãƒ¼ãƒ ãªã—")
```

---

## 6ï¸âƒ£ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®

### å‡¦ç†æ™‚é–“ç›®æ¨™

| æ“ä½œ | ç›®æ¨™æ™‚é–“ | èª¬æ˜ |
|------|---------|------|
| measure_at_rgb_coords() | <10ms | å˜ä¸€ãƒ”ã‚¯ã‚»ãƒ«æ¸¬å®š |
| measure_at_region() | <50ms | 50x50pxé ˜åŸŸã®çµ±è¨ˆ |
| save() | <100ms | JSONä¿å­˜ |
| load() | <50ms | JSONèª­ã¿è¾¼ã¿ |

### æœ€é©åŒ–æŠ€æ³•

```python
# 1. ãƒ•ãƒ¬ãƒ¼ãƒ ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
depth_frame_cache = None
last_fetch_time = 0

def get_cached_depth_frame():
    global depth_frame_cache, last_fetch_time
    if time.time() - last_fetch_time > 33ms:  # 30fpsä»¥ä¸Š
        depth_frame_cache = camera_manager.get_depth_frame()
        last_fetch_time = time.time()
    return depth_frame_cache

# 2. å‘¨è¾ºå€¤è£œé–“ã®æœ€é©åŒ–ï¼ˆã‚¹ãƒ‘ã‚¤ãƒ©ãƒ«ã‚µãƒ¼ãƒï¼‰
def interpolate_nearby(x, y, radius=10):
    for r in range(1, radius):
        for dx in range(-r, r+1):
            for dy in range(-r, r+1):
                if (x+dx, y+dy) in valid_range:
                    if depth_at(x+dx, y+dy) > 0:
                        return depth_at(x+dx, y+dy)
    return None
```

---

## 7ï¸âƒ£ ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

```python
# tests/test_depth_service.py

def test_measure_valid_coords():
    """æœ‰åŠ¹ãªåº§æ¨™ã§æ¸¬å®š"""
    
def test_measure_invalid_coords():
    """ç¯„å›²å¤–ã®åº§æ¨™ã¯ -1.0 ã‚’è¿”ã™"""
    
def test_measure_region_mean():
    """çŸ©å½¢é ˜åŸŸã®å¹³å‡ã‚’è¨ˆç®—"""
    
def test_interpolation():
    """ç„¡åŠ¹å€¤ã®å ´åˆã€å‘¨è¾ºå€¤ã‹ã‚‰è£œé–“"""
    
def test_save_load():
    """æ·±åº¦ã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿"""
```

### çµ±åˆãƒ†ã‚¹ãƒˆ

```python
# æ·±åº¦è¨­å®šUI + ã‚µãƒ¼ãƒ“ã‚¹
# OXã‚²ãƒ¼ãƒ  + ã‚µãƒ¼ãƒ“ã‚¹
# è¤‡æ•°ã‚²ãƒ¼ãƒ  + å…±æœ‰ã‚µãƒ¼ãƒ“ã‚¹
```

---

## 8ï¸âƒ£ ä½¿ç”¨ä¾‹

### æ·±åº¦è¨­å®šUI

```python
from common.depth_service import DepthMeasurementService, DepthStorageService

class DepthConfigUI:
    def __init__(self, camera_manager):
        self.measurement_service = DepthMeasurementService(camera_manager)
        self.storage_service = DepthStorageService()
    
    def on_video_click(self, x: int, y: int):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯"""
        depth_m = self.measurement_service.measure_at_rgb_coords(x, y)
        if depth_m > 0:
            self.display_label.setText(f"Depth: {depth_m:.3f}m")
    
    def on_save_clicked(self):
        """ä¿å­˜ãƒœã‚¿ãƒ³"""
        # æœ€å¾Œã«æ¸¬å®šã—ãŸå€¤ã‚’ä¿å­˜
        if self.storage_service.save(self.last_measured_depth):
            self.show_message("ä¿å­˜æˆåŠŸ")
```

### OXã‚²ãƒ¼ãƒ 

```python
from common.depth_service import DepthMeasurementService

class OxGame:
    def __init__(self, camera_manager):
        self.depth_service = DepthMeasurementService(camera_manager)
    
    def _update_frame(self):
        # ãƒœãƒ¼ãƒ«ä½ç½®ã‚’æ¤œå‡º
        ball_x, ball_y = self.detect_ball(frame)
        
        # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ·±åº¦ã‚’å–å¾—
        depth_m = self.depth_service.measure_at_rgb_coords(ball_x, ball_y)
        
        # ç”»é¢ã«è¡¨ç¤º
        painter.drawText(ball_x, ball_y, f"{depth_m:.2f}m")
```

---

**ã“ã‚Œã§å®Ÿè£…ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼**

