#!/usr/bin/env python3
"""
【深度設定機能ガイド】
スクリーンまでの距離を設定する機能の詳細説明

スクリーンの位置（奥行き）を mm 単位で設定し、
ボール衝突判定で使用する深度情報に反映
"""

DEPTH_SETTING_GUIDE = """
================================================================================
🎯【深度設定機能の概要】
================================================================================

【目的】
────────────────────────────────────────────────────────────────────────────
スクリーンまでの距離を明示的に設定することで、
ボール追跡・衝突判定時に正確な深度情報を利用できます。

【必要な理由】
────────────────────────────────────────────────────────────────────────────
• ボール軌跡検出が正確になる
• 衝突判定の精度が向上する
• スクリーン前後でのボール位置判定が明確になる

================================================================================
📋【UI フロー】
================================================================================

【1】主ウィンドウから「深度設定」ボタンをクリック
────────────────────────────────────────────────────────────────────────────

  主ウィンドウ (main_window.py)
    ↓
  【深度設定】ボタン
    ↓
  show_set_screen_depth() が呼び出される


【2】ダイアログ入力画面
────────────────────────────────────────────────────────────────────────────

  QInputDialog が表示される
    │
    ├─ タイトル: "深度設定"
    ├─ プロンプト: "深度 (mm):"
    ├─ 初期値: 現在設定されている深度（ログから読み込み）
    ├─ 最小値: 0 mm
    └─ OK/キャンセル ボタン

  例：
    ┌──────────────────────────────┐
    │       深度設定               │
    ├──────────────────────────────┤
    │  深度 (mm):                  │
    │  ┌──────────────────────────┐│
    │  │ 500                      ││  ← ユーザー入力
    │  └──────────────────────────┘│
    │                              │
    │       [OK]      [キャンセル]  │
    └──────────────────────────────┘


【3】深度データの保存
────────────────────────────────────────────────────────────────────────────

  ユーザー入力値
    ↓
  screen_manager.set_screen_depth(depth)
    ↓
  メモリに保存（self.screen_depth = depth）
  + JSON ログファイルに保存
    ↓
  ScreenDepthLogs/depth_log.json
    │
    └─ 起動時に自動読み込み

================================================================================
🔧【実装詳細】
================================================================================

【ファイル構成】
────────────────────────────────────────────────────────────────────────────

📄 frontend/main_window.py
   └─ show_set_screen_depth()
      └─ ユーザーに深度入力ダイアログを表示
      └─ screen_manager.set_screen_depth(depth) を呼び出し

📄 backend/screen_manager.py
   ├─ set_screen_depth(depth: float)
   │  └─ self.screen_depth = depth
   │  └─ _save_depth_log() で JSON に保存
   │
   └─ get_screen_depth() -> float
      └─ 現在の深度値を返す
      └─ 未設定時は 0.0 を返す

📄 ScreenDepthLogs/depth_log.json
   └─ 深度設定の永続化ファイル
      ```json
      {
        "screen_depth": 500
      }
      ```

【実装コード】
────────────────────────────────────────────────────────────────────────────

▶️  深度設定（書き込み）
  backend/screen_manager.py:

    def set_screen_depth(self, depth: float) -> None:
        """スクリーン距離を設定する"""
        self.screen_depth = depth
        self._save_depth_log()


▶️  深度取得（読み込み）
  backend/screen_manager.py:

    def get_screen_depth(self) -> float:
        """設定済みのスクリーンまでの距離を取得する"""
        return self.screen_depth or 0.0


▶️  UI からの呼び出し
  frontend/main_window.py:

    def show_set_screen_depth(self) -> None:
        """スクリーン深度設定機能"""
        try:
            self.screen_manager.load_log()
            current_depth = int(self.screen_manager.get_screen_depth())
        except Exception as e:
            current_depth = 0

        depth, ok = QInputDialog.getInt(
            self,
            "深度設定",
            "深度 (mm):",
            current_depth,
            0,
        )
        if ok:
            self.screen_manager.set_screen_depth(depth)
            QMessageBox.information(self, "深度設定", f"深度を {depth} mm に設定しました。")

================================================================================
📊【データフロー】
================================================================================

カメラフレーム取得
  ↓
ボール検出
  ↓
深度値の取得
  ├─ カメラの深度センサーから実測値を取得
  │
深度値の参照
  └─ 設定されたスクリーン深度と比較
  
衝突判定
  ├─ ボール深度 < スクリーン深度
  │   → ボールはスクリーン手前
  │
  ├─ ボール深度 ≈ スクリーン深度
  │   → ボールはスクリーン上にある ✓ ヒット判定
  │
  └─ ボール深度 > スクリーン深度
      → ボールはスクリーン奥

================================================================================
⚙️【関連設定】
================================================================================

common/config.py での深度関連設定：

  # 衝突判定用深度閾値（メートル単位）
  COLLISION_DEPTH_THRESHOLD = 0.15   # 150mm = 15cm
  
  # 深度測定の有効範囲上限（mm）
  MAX_VALID_DEPTH_MM = 5000   # 5m までを有効とみなす

【ハードウェア対応範囲】
  DepthAI の深度測定範囲:
  • 最小距離: 約 20cm（固体 OAK-D の仕様）
  • 最大距離: 約 5m（室内標準的な条件下）

================================================================================
🎮【使用シーン】
================================================================================

【シーン1】初回セットアップ
────────────────────────────────────────────────────────────────────────────
1. アプリを起動
2. 「深度設定」ボタンをクリック
3. スクリーンまでの距離を mm 単位で入力
   例: 500 mm（50cm）
4. 【OK】で確定

【シーン2】深度値の変更
────────────────────────────────────────────────────────────────────────────
1. 「深度設定」ボタンをクリック
2. 前回設定値が表示される
3. 新しい距離に変更
4. 【OK】で確定

【シーン3】現在の深度確認
────────────────────────────────────────────────────────────────────────────
1. 「深度確認」ボタンをクリック
2. 現在設定されている深度がダイアログに表示される

================================================================================
💡【推奨値と調整】
================================================================================

【典型的なセットアップ】
────────────────────────────────────────────────────────────────────────────

デスクトップ環境:
  スクリーン距離: 300～600 mm（30～60 cm）
  推奨値: 500 mm

テーブルトップゲーム:
  スクリーン距離: 800～1200 mm（80～120 cm）
  推奨値: 1000 mm

展示会・デモ環境:
  スクリーン距離: 500～1500 mm（50～150 cm）
  推奨値: 800 mm

【精度向上のコツ】
────────────────────────────────────────────────────────────────────────────

1. 実測で確認
   └─ スクリーン位置からカメラまでの距離をメジャーで計測

2. 衝突判定の余裕を考慮
   └─ COLLISION_DEPTH_THRESHOLD を調整（デフォルト 15cm）

3. 照明環境を整える
   └─ DepthAI の深度測定精度は照明に依存

4. テスト実行
   └─ ボール軌跡が正確に検出されるか確認

================================================================================
🐛【トラブルシューティング】
================================================================================

【問題1】深度設定が反映されない
────────────────────────────────────────────────────────────────────────────
原因: ログファイルが読み込まれていない
解決:
  • アプリを再起動
  • ScreenDepthLogs/ ディレクトリが存在することを確認
  • JSON ファイルの形式が正しいか確認

【問題2】衝突判定が機能しない
────────────────────────────────────────────────────────────────────────────
原因: 深度値が設定されていない / カメラ深度が取得されていない
解決:
  • 「深度設定」で値を明示的に入力
  • 「深度確認」で現在値が 0 でないか確認
  • カメラの深度ストリームが正常に起動しているか確認

【問題3】毎回初期化される
────────────────────────────────────────────────────────────────────────────
原因: ScreenDepthLogs/ フォルダへの書き込み権限がない
解決:
  • ディレクトリの書き込み権限を確認
  • Windows: フォルダプロパティ → セキュリティ → 権限確認
  • Linux/Mac: chmod 755 ScreenDepthLogs/

================================================================================
🔗【関連機能との連携】
================================================================================

【ボール追跡（ball_tracker.py）】
  get_screen_depth() を使用して、深度判定を実施
  
    depth = self.screen_manager.get_screen_depth() or 1.0
    if abs(ball_depth - depth) < threshold:
        # ヒット判定
        pass

【衝突検出（hit_detection.py）】
  深度閾値 COLLISION_DEPTH_THRESHOLD と組み合わせて使用

【ゲームロジック（game_logic.py）】
  衝突判定結果を受け取り、ゲーム状態を更新

================================================================================
📖【参考リンク】
================================================================================

• DepthAI SDK ドキュメント
  https://docs.luxonis.com/

• 深度測定の仕組み
  https://docs.luxonis.com/projects/api/en/latest/components/nodes/stereo_depth/

• OAK-D スペック
  https://docs.luxonis.com/projects/hardware/en/latest/

================================================================================
"""

if __name__ == '__main__':
    print(DEPTH_SETTING_GUIDE)
    
    # ガイドをファイルに保存
    with open("DEPTH_SETTING_GUIDE.txt", "w", encoding="utf-8") as f:
        f.write(DEPTH_SETTING_GUIDE)
    
    print("\n💾 深度設定ガイドを DEPTH_SETTING_GUIDE.txt に保存しました\n")
