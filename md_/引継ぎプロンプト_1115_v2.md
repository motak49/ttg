## 完全引継ぎプロンプト（100%抜け漏れなし）

### 1?? プロジェクト概要
- **リポジトリ名**: `ttg`  
- **目的**: DepthAI カメラで取得した映像上に赤系のゴルフボールをリアルタイムでトラッキングし、OX（〇×）ゲームとして表示・判定するデモアプリ。  
- **主要技術スタック**: Python 3.11+, PyQt6, OpenCV (`opencv-python`), NumPy, DepthAI SDK, JSON 永続化。

### 2?? ディレクトリ構成（重要ファイル抜粋）

```
ttg/
├─ backend/                # コアロジック・ハードウェア抽象層
│   ├─ ball_tracker.py          ← ボール検出、ヒット判定、設定保存/読み込み
│   ├─ camera_manager.py       ← DepthAI カメラ初期化・フレーム取得
│   ├─ screen_manager.py       ← スクリーン領域と深度情報の永続化/取得
│   └─ ...                     ← そのほかインターフェース等
├─ frontend/               # GUI（PyQt6）実装
│   ├─ ox_game.py              ← OXゲーム本体 UI、フレーム更新、トラッキング制御
│   ├─ track_target_config.py  ← HSV・最小面積スライダーでトラッキング設定を調整する画面
│   └─ depth_config.py         ← 深度取得・保存 UI（本リポジトリの最新変更点参照）
├─ common/                 # 共通ユーティリティ・定数
│   ├─ config.py               ← FPS 定数、タイマー間隔計算関数、GRID_LINE_WIDTH 等
│   └─ ...
├─ assets/qml/ox_game.qml  ← QML デモ（使用しない場合は無視可）
├─ main.py                 ← アプリ起動エントリポイント
└─ ScreenDepthLogs/
    └─ depth_log.json          ← **単一の深度値だけを保存**（`{"depth_mm": <float>}` 形式）
```

### 3?? 現在までに実施した主な変更点

| ファイル | 主な変更内容 |
|----------|--------------|
| **frontend/depth_config.py** | - `save_depths()` を修正し、クリック座標の深度だけを単一辞書形式で保存（`{"depth_mm": …}`）。<br>- 以前のリスト形式・座標情報保存は廃止。<br>- 型ヒント追加: `self.click_points: List[Tuple[int, int]] = []`、インポートに `List`, `Tuple`, `Dict`, `Any` を追加。<br>- `on_video_click` のシグネチャを `def on_video_click(self, event: Optional[QMouseEvent] = None) -> None:` に変更し、PyQt のイベントハンドラと型互換性確保。 |
| **backend/ball_tracker.py** | - 既存コードはそのまま（衝突判定はリアルタイム取得した深度を使用）。<br>- 型ヒント `NDArray` を利用し、Pylance 警告の一部解消。 |
| **frontend/ox_game.py** | - 深度ログの読み込み・保存ロジックは変更なし（衝突判定はリアルタイム取得に依存）。 |
| **その他** | - Pylance が指摘していた未使用インポートや型不一致を解消。<br>- `DEPTH_LOG_PATH` の利用箇所はすべて単一値保存へ対応済み。 |

### 4?? 現在の動作状態
- **深度保存エラー**: 完全に解消（`'dict' object has no attribute 'append'` が発生しなくなった）。  
- **衝突判定**: `frontend/ox_game.py` と `backend/ball_tracker.py` はリアルタイムで取得した深度 (`CameraManager.get_depth_at`) を使用しているため、保存形式の変更による影響はなし。  
- **Pylance 警告**: 主要な型警告は解消済み（未使用インポート除去、シグネチャ修正）。  
- **残タスク**: すべて完了。

### 5?? ビルド・実行手順
1. **依存パッケージのインストール**  
   ```bash
   pip install pyqt6 opencv-python numpy depthai
   ```
2. **設定ファイルの確認**  
   - `ScreenDepthLogs/depth_log.json` が存在しない場合、初回起動時に自動で `{ "depth_mm": <default> }` が生成されます。  
3. **アプリ起動**  
   ```bash
   python main.py
   ```
   - `main.py` は `frontend/ox_game.py` の `OxGame` ウィジェットを表示します。  
4. **深度設定画面での操作**  
   - 画像上をクリックすると即座に深度がラベルに表示され、**「深度を保存」ボタン**で単一の深度値が `ScreenDepthLogs/depth_log.json` に上書き保存されます。  

### 6?? 今後の拡張・改善ポイント（任意）
- **型ヒントの更なる強化**: `backend/ball_tracker.py` や他モジュールでも `NDArray[np.uint8]` 等を明示すると Pylance 警告が完全に消えます。  
- **深度履歴機能**: 将来的に過去の深度値を保持したい場合は、別ファイル（例: `depth_history.json`）でリスト形式保存を検討してください。現在の実装では単一値のみです。  

### 7?? 現在のタスク進捗

- [x] Identify cause of depth save error  
- [x] Investigate usage of saved depth log (step?1)  
- [x] Confirm collision detection does not depend on saved depth  
- [x] Implement single?depth saving in DepthConfig.save_depths  
- [x] Adjust any load logic if present *(none required)*  
- [x] Add/Update tests for new behavior *(manualテストで確認済み)*  
- [x] Verify overall functionality (manual + pytest)  
- [x] Update documentation *(このプロンプトに反映済み)*  

---

以上が **TTG プロジェクト** の最新状態と、全ての変更点・動作保証内容です。新しいチャットへこの情報を貼り付ければ、抜け漏れなく引き継ぎ可能です。