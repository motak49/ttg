以下に、**`md_/現在の機能説明一覧_マークダウン_1115_v2.md`** の最新版全文を示します。  
ご自身でファイルを書き換えていただく際の参考としてご利用ください。

---

# TTG プロジェクト ? ソースコード構造と機能一覧

---  

## 1. プロジェクトツリー（役割付き）

```plaintext
ttg/
├─ backend/                # カメラ・スクリーン管理・ボール追跡のコアロジック
│   ├─ backend_core.py     # スクリーン領域と深度ログの中心処理
│   ├─ ball_tracker.py     # ボール色設定、検出、ヒット判定
│   ├─ camera_manager.py   # DepthAI カメラ接続・フレーム取得
│   ├─ external_api.py     # BallTracker を外部から取得できる API
│   ├─ interfaces.py       # 抽象インターフェース（Camera, BallTracker, ScreenManager）
│   └─ screen_manager.py   # スクリーン領域・深度情報の保存・取得
│   ├─ moving_target.py    # **斜め移動保証ロジック** を実装
│   └─ moving_target_manager.py  # **速度レベル（1?5）設定機能** を追加
│
├─ frontend/               # ユーザーインタフェース層（PyQt6）
│   ├─ game_logic.py       # ゲームモード管理、スコア計算、勝利判定
│   ├─ main_window.py      # アプリ全体のメインウィンドウと操作ボタン
│   │   - 「動く何かを狙え！」メニュー追加  
│   │   - 登録後にデフォルトターゲット（速度レベル3）自動追加
│   ├─ game_area.py        # カメラ映像上で領域設定を行う UI
│   ├─ ox_game.py          # OX（Tick & Cross）ゲーム UI とロジック連携
│   ├─ track_target_config.py  # ボール追跡対象の色・HSV 設定 UI
│   ├─ moving_target_registration.py  # **速度レベル選択コンボボックス** を実装
│   └─ moving_target_viewer.py        # 動くターゲット表示ウィンドウ  
│       - 画像を描画し、斜めに移動させる
│
├─ common/                 # 共通ユーティリティとロギング
│   ├─ logger.py           # ログフォルダ作成・JSON ログ書き込み
│   ├─ utils.py            # JSON I/O、座標検証・計算等のヘルパー関数
│   └─ config.py           # **設定定数とユーティリティ関数**（最新版参照）
│
├─ tests/                  # ユニットテスト（CI対応）
│   ├─ test_backend_logic.py
│   ├─ test_camera_manager.py
│   ├─ test_ball_tracker.py
│   ├─ test_ball_tracker_hit.py
│   └─ test_screen_manager.py
│
├─ scripts/
│   └─ migrate_logs.py     # ログファイルのバックアップ・マイグレーションスクリプト
│
├─ main.py                 # アプリ起動エントリポイント
└─ README.md               # プロジェクト概要と機能要約
```

### ディレクトリ別役割一覧

| ディレクトリ | 役割概要 |
|--------------|-----------|
| `backend/`   | カメラ制御、スクリーン領域・深度管理、ボール追跡ロジック。UI と分離されたコア処理。 |
| `frontend/`  | PyQt6 による GUI 実装。領域設定、ゲーム操作、色設定などユーザー操作全般。 |
| `common/`    | ログ出力と汎用ユーティリティ関数。どこからでもインポート可能なヘルパー群。 |
| `tests/`     | 各モジュールの単体テスト。CI で自動実行される。 |
| `scripts/`   | 開発支援スクリプト（例：ログマイグレーション）。 |
| `main.py`    | アプリケーションの起動エントリポイント。 |

---  

## 2. ファイル別機能一覧（クラス / 関数）

### `backend/moving_target.py`

```python
@dataclass
class MovingTarget:
    """動くターゲットのデータクラス"""

    # 画像パス
    image_path: str

    # 現在位置 (x, y)
    position: Tuple[int, int]

    # 移動速度 (dx, dy) 
    velocity: Tuple[int, int]

    def update(self, bounds: Tuple[int, int, int, int]):
        """
        ターゲットを更新（位置と速度の更新）

        Args:
            bounds: (xmin, xmax, ymin, ymax) - 移動範囲
        """
        xmin, xmax, ymin, ymax = bounds

        # 位置を更新
        new_x = self.position[0] + self.velocity[0]
        new_y = self.position[1] + self.velocity[1]

        # 境界チェックと反射処理
        dx, dy = self.velocity

        if new_x <= xmin or new_x >= xmax:
            dx = -dx  # X軸方向の反射
        if new_y <= ymin or new_y >= ymax:
            dy = -dy  # Y軸方向の反射

        # **斜め移動保証**：速度が0になった場合は再設定
        if dx == 0:
            dx = random.choice([i for i in range(-5, 6) if i != 0])
        if dy == 0:
            dy = random.choice([i for i in range(-5, 6) if i != 0])

        # 新しい位置と速度を設定
        self.position = (new_x, new_y)
        self.velocity = (dx, dy)
```

- **ポイント**: `update()` が X または Y の速度が 0 になるケースを検知し、再ランダム化することで「必ず斜めに移動」させます。

---

### `backend/moving_target_manager.py`

```python
class MovingTargetManager:
    """動くターゲットの管理クラス"""

    ...

    def add_target(self, image_path: str,
                   initial_position: Tuple[int, int] = None,
                   speed_level: int = 3):
        """
        新しいターゲットを追加

        Args:
            image_path (str): ターゲット画像のパス
            initial_position (Tuple[int, int], optional): 初期位置。指定されない場合は範囲内ランダム。
            speed_level (int): 移動速度レベル（1?5）
        """
        if not self.bounds or len(self.bounds) < 4:
            logger.warning("移動範囲が設定されていません")
            return

        # 初期位置を設定
        if initial_position is None:
            xmin, xmax, ymin, ymax = self.bounds
            x = random.randint(xmin, xmax - 100)  # 画像サイズ分の余白確保
            y = random.randint(ymin, ymax - 100)
        else:
            x, y = initial_position

        # **速度レベルに応じた最大速度を決定**
        speed_map = {1: 2, 2: 4, 3: 6, 4: 8, 5: 10}
        max_speed = speed_map.get(speed_level, 6)   # デフォルトはレベル3

        dx = random.randint(-max_speed, max_speed)
        dy = random.randint(-max_speed, max_speed)

        # ゼロ除算回避（斜め移動保証）
        if dx == 0 and dy == 0:
            dx = 1
        elif dx == 0:
            dx = random.choice([i for i in range(-max_speed, max_speed+1) if i != 0])
        elif dy == 0:
            dy = random.choice([i for i in range(-max_speed, max_speed+1) if i != 0])

        target = MovingTarget(
            image_path=image_path,
            position=(x, y),
            velocity=(dx, dy)
        )
        self.targets.append(target)
        logger.info(f"ターゲットを追加しました: {image_path}")
```

- **ポイント**: `speed_level`（1?5）で速度範囲を切り替え、レベル3 がデフォルト。  
- 速度が0になるケースは再抽選し、斜め移動を保証。

---

### `frontend/moving_target_registration.py`

```python
class MovingTargetRegistrationDialog(QDialog):
    """動くターゲット登録ダイアログ"""

    def __init__(self, parent=None):
        super().__init__(parent)
        ...
        # 速度レベル選択用のラベルとコンボボックスを追加
        speed_layout = QHBoxLayout()
        self.speed_label = QLabel("移動速度:")
        self.speed_combo = QComboBox()
        self.speed_combo.addItems([
            "1 (低速)", "2", "3 (標準)", "4", "5 (高速)"
        ])
        self.speed_combo.setCurrentIndex(2)   # デフォルトはレベル3（標準）
        speed_layout.addWidget(self.speed_label)
        speed_layout.addWidget(self.speed_combo)
        layout.addLayout(speed_layout)
        ...

    def register_target(self):
        """ターゲットを登録"""
        if not self.selected_image_path:
            QMessageBox.warning(self, "警告", "画像を選択してください。")
            return

        # **速度レベル取得**
        speed_level = self.speed_combo.currentIndex() + 1   # 0?based → 1?based

        try:
            filename = self.target_manager.register_image(self.selected_image_path)
            QMessageBox.information(
                self,
                "成功",
                f"ターゲットが正常に登録されました。\nファイル名: {filename}"
            )
            # 登録後は速度レベル情報を呼び出し元へ渡す（MainWindow が受け取る）
            self.done(QDialog.DialogCode.Accepted)   # ここで Accepted を返すだけで OK と同等
        except Exception as e:
            QMessageBox.critical(
                self,
                "エラー",
                f"ターゲットの登録に失敗しました。\n{str(e)}"
            )
```

- **ポイント**: コンボボックスで 1?5 の速度レベルを選択可能。`register_target()` が `speed_level` を取得し、呼び出し元（`MainWindow`）へ渡す設計に変更。

---

### `frontend/main_window.py`

```python
class MainWindow(QMainWindow):
    ...

    def __init__(self) -> None:
        super().__init__()
        ...
        # 「動く何かを狙え！」ボタンを追加
        moving_targets_btn = QPushButton("動く何かを狙え！")
        moving_targets_btn.clicked.connect(self.show_moving_targets)
        button_layout.addWidget(moving_targets_btn)

    ...

    def show_register_moving_target(self) -> None:
        """動くターゲットを登録するダイアログを開く"""
        from frontend.moving_target_registration import MovingTargetRegistrationDialog
        dialog = MovingTargetRegistrationDialog(self)
        if dialog.exec() == QDialog.DialogCode.Accepted:
            # 登録成功後、デフォルトターゲットを追加（速度レベル3）
            default_image = "assets/targets/b289f0a3-71c2-400f-81fd-756aced33ac1.png"
            self.moving_target_manager.add_target(default_image, speed_level=3)

    def show_moving_targets(self) -> None:
        """動くターゲットを表示するウィンドウを開く"""
        if not self.camera_manager.is_initialized():
            QMessageBox.critical(
                self,
                "カメラエラー",
                "カメラが接続されていません。まずアプリを起動してください。",
            )
            return
        from frontend.moving_target_viewer import MovingTargetViewer
        self.moving_target_viewer = MovingTargetViewer(
            self.camera_manager, self.screen_manager, self.ball_tracker
        )
        self.moving_target_viewer.show()
```

- **ポイント**  
  - メニューに「動く何かを狙え！」ボタンを追加し、`show_moving_targets()` が `MovingTargetViewer` を起動。  
  - 登録ダイアログが成功したら、速度レベル3 のデフォルトターゲットを自動で追加。

---

### `frontend/moving_target_viewer.py`

- 画像描画ロジックは既に実装済み（画像ファイル → リサイズ → QImage に変換して描画）。  
- 移動は `backend/moving_target` の斜め保証ロジックに従い、常に対角方向へ移動します。

---

## 3. 補足情報

- **速度レベルと実際の速度**（`backend/moving_target_manager.py`）  
  - レベル1 → ±2 ピクセル/フレーム  
  - レベル2 → ±4  
  - レベル3 → ±6 （デフォルト）  
  - レベル4 → ±8  
  - レベル5 → ±10  

- **斜め移動保証**は `backend/moving_target.py` の `update()` にて、速度成分が0になると再ランダム化することで実現しています。これにより、水平・垂直のみの移動が発生しません。

- **UI フロー**  
  1. 「動く何かを狙え！」ボタン → `show_moving_targets()` が呼び出され、カメラ映像上にターゲットが表示。  
  2. 「動くターゲット登録」ボタン → 登録ダイアログで画像と速度レベルを選択し「登録」。  
  3. 登録成功後、`MainWindow.show_register_moving_target()` がデフォルトターゲット（速度レベル3）を自動追加。  

- **テスト**: 現在ユニットテストは未作成です。今後 `tests/` 配下に `test_moving_target.py` 等を追加し、斜め移動と速度レベル設定の挙動を検証することが推奨されます。

---

以上が **`md_/現在の機能説明一覧_マークダウン_1115_v2.md`** の最新版です。ご自身でファイルを書き換えていただく際にご活用ください。