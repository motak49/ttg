---

---

# TTG プロジェクト ? ソースコード構造と機能一覧

---

## 1. プロジェクトツリー（役割付き）

### ディレクトリ構造

```plaintext
ttg/
├─ backend/                # カメラ・スクリーン管理・ボール追跡のコアロジック
│   ├─ backend_core.py     # スクリーン領域と深度ログの中心処理
│   ├─ ball_tracker.py     # ボール色設定、検出、ヒット判定
│   ├─ camera_manager.py   # DepthAI カメラ接続・フレーム取得
│   ├─ external_api.py     # BallTracker を外部から取得できる API
│   ├─ interfaces.py       # 抽象インターフェース（Camera, BallTracker, ScreenManager）
│   └─ screen_manager.py   # スクリーン領域・深度情報の保存・取得
│
├─ frontend/               # ユーザーインタフェース層（PyQt6）
│   ├─ game_logic.py       # ゲームモード管理、スコア計算、勝利判定
│   ├─ main_window.py      # アプリ全体のメインウィンドウと操作ボタン
│   ├─ game_area.py        # カメラ映像上で領域設定を行う UI
│   ├─ ox_game.py          # OX（Tick & Cross）ゲーム UI とロジック連携
│   ├─ track_target_config.py  # ボール追跡対象の色・HSV 設定 UI
│   └─ track_target_viewer.py  # 追跡対象を映像上にハイライト表示する UI
│
├─ common/                 # 共通ユーティリティとロギング
│   ├─ logger.py           # ログフォルダ作成・JSON ログ書き込み
│   ├─ utils.py            # JSON I/O、座標検証・計算等のヘルパー関数
│   └─ config.py           # **設定定数とユーティリティ関数**（最新版参照）
│
├─ tests/                  # ユニットテスト（CI対応）
│   ├─ test_backend_logic.py
│   ├─ test_camera_manager.py
│   ├─ test_ball_tracker.py
│   ├─ test_ball_tracker_hit.py
│   └─ test_screen_manager.py
│
├─ scripts/
│   └─ migrate_logs.py     # ログファイルのバックアップ・マイグレーションスクリプト
│
├─ main.py                 # アプリ起動エントリポイント
└─ README.md               # プロジェクト概要と機能要約
```

### ディレクトリ別役割一覧

| ディレクトリ | 役割概要 | |--------------|-----------| | `backend/` | カメラ制御、スクリーン領域・深度管理、ボール追跡ロジック。UI と分離されたコア処理。 | | `frontend/` | PyQt6 による GUI 実装。領域設定、ゲーム操作、色設定などユーザー操作全般。 | | `common/` | ログ出力と汎用ユーティリティ関数。どこからでもインポート可能なヘルパー群。 | | `tests/` | 各モジュールの単体テスト。CI で自動実行される。 | | `scripts/` | 開発支援スクリプト（例：ログマイグレーション）。 | | `main.py` | アプリケーションの起動エントリポイント。 |

---

## 2. ファイル別機能一覧（クラス / 関数）

### `backend/backend_core.py`

#### クラス: `BackendCore`

- スクリーン領域・深度ログのコア管理。
- 主なメソッド: `set_screen_area`, `get_screen_area`, `load_screen_area` など。

---

### `backend/ball_tracker.py`

#### クラス: `BallTracker`（実装 `BallTrackerInterface`）

- ボール色設定、HSV 範囲での検出、ヒット座標取得・判定。
- 主なメソッド: `set_target_color`, `detect_ball`, `get_hit_area`, `check_target_hit`。
- __変更点__: `detect_ball` に最小面積フィルタ（`min_area = 100`）を追加し、ノイズ除去と高速ボールの安定検出を実現。

---

### `backend/camera_manager.py`

#### クラス: `CameraManager`（実装 `CameraInterface`）

- DepthAI カメラの初期化、フレーム取得、FPS 設定、クローズ処理。
- 主なメソッド: `initialize_camera`, `get_frame`, `close_camera`。

---

### `backend/external_api.py`

#### モジュール関数・変数

- `_ball_tracker`（グローバルインスタンス）
- `set_ball_tracker(ball_tracker)`, `get_target_position()`。

---

### `backend/interfaces.py`

#### 抽象クラス群

- `CameraInterface`, `BallTrackerInterface`, `ScreenManagerInterface`。

---

### `backend/screen_manager.py`

#### クラス: `ScreenManager`

- スクリーン領域（4点リスト）と深度情報の保存・取得、ログ入出力を担当。

## `common/config.py` __（最新版）__

```python
# common/config.py
"""
共通設定ファイル

- 各 UI の目標フレームレート (FPS)
- タイマー間隔 (ms) を FPS から計算するユーティリティ関数
"""

# OxGame 用フレームレート（約120fps）
OX_GAME_TARGET_FPS = 120
TARGET_FPS = OX_GAME_TARGET_FPS

# TrackTargetConfig 用フレームレート（約120fps）※将来的に別設定へ拡張可
TRACK_TARGET_CONFIG_FPS = 120

GRID_LINE_WIDTH = 20   # グリッド線幅（ピクセル）

def timer_interval_ms(fps: int) -> int:
    """
    FPS からタイマー間隔 (ms) を計算します。
    最小 1 ms に丸め込み、整数で返却します。

    Args:
        fps: 目標フレームレート

    Returns:
        タイマーに渡すミリ秒数
    """
    if fps <= 0:
        return 1
    # round to nearest integer millisecond
    return max(1, int(round(1000 / fps)))
```

---

## `frontend/ox_game.py` __（最新版）__

### 主な変更点

1. __FPS 表示ラベル__

   - 左上に固定で `FPS: 120 (実測: xx.x)` を表示。

2. __非モーダル交代ダイアログ__

   - `_show_turn_change_message` が `Qt.WindowModality.NonModal` に変更され、2 秒後自動閉鎖しトラッキング再開。

3. __プレイヤー交代タイミングの明確化__

   - ヒット処理（ステップ 3）完了後のみ `_show_turn_change_message` が呼び出されるよう `_process_hit` にロジックを組み込み。

4. __検出対象可視化__

   - 緑色 30px 四角形でトラッキング対象をハイライト。
   - 衝突は半径 50px の青円（1 回だけ）で表示し、以降は同ターン内で再描画しない。

5. __グリッド線幅__

   - `common/config.py` の `GRID_LINE_WIDTH = 20` を使用し、ブロック間の線が太くなった。

### 効果

- __高速ボールでも安定検出__（最小面積フィルタによりノイズ除去）。
- __ダイアログ永遠表示バグ解消__（非モーダル化と正しいタイミングでの呼び出し）。
- __FPS 可視化でパフォーマンス把握が容易__。

---

## `frontend/game_area.py`、`frontend/main_window.py`、`frontend/track_target_config.py`、`frontend/track_target_viewer.py`

（変更なし）※ UI 全体は変わらず、FPS 表示は `OxGame` に限定。
