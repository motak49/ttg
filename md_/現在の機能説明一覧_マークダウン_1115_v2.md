以下に、現在のソースコードと機能を反映した最新版 **`md_/現在の機能説明一覧_マークダウン_1115_v2.md`** の全文を示します。

---  

# TTG プロジェクト ? ソースコード構造と機能一覧

---  

## 1. プロジェクトツリー（役割付き）

```plaintext
ttg/
├─ backend/                # カメラ・スクリーン管理・ボール追跡のコアロジック
│   ├─ backend_core.py     # スクリーン領域と深度ログの中心処理
│   ├─ ball_tracker.py     # ボール色設定、検出、ヒット判定
│   ├─ camera_manager.py   # DepthAI カメラ接続・フレーム取得
│   ├─ external_api.py     # BallTracker を外部から取得できる API
│   ├─ interfaces.py       # 抽象インターフェース（Camera, BallTracker, ScreenManager）
│   └─ screen_manager.py   # スクリーン領域・深度情報の保存・取得
│
├─ frontend/               # ユーザーインタフェース層（PyQt6）
│   ├─ game_logic.py       # ゲームモード管理、スコア計算、勝利判定
│   ├─ main_window.py      # アプリ全体のメインウィンドウと操作ボタン
│   ├─ game_area.py        # カメラ映像上で領域設定を行う UI
│   ├─ ox_game.py          # OX（Tick & Cross）ゲーム UI とロジック連携
│   ├─ track_target_config.py  # ボール追跡対象の色・HSV 設定 UI
│   └─ track_target_viewer.py  # トラッキング対象を映像上にハイライト表示する UI
│
├─ common/                 # 共通ユーティリティとロギング
│   ├─ logger.py           # ログフォルダ作成・JSON ログ書き込み
│   ├─ utils.py            # JSON I/O、座標検証・計算等のヘルパー関数
│   └─ config.py           # **設定定数とユーティリティ関数**（最新版参照）
│
├─ tests/                  # ユニットテスト（CI対応）
│   ├─ test_backend_logic.py
│   ├─ test_camera_manager.py
│   ├─ test_ball_tracker.py
│   ├─ test_ball_tracker_hit.py
│   └─ test_screen_manager.py
│
├─ scripts/
│   └─ migrate_logs.py     # ログファイルのバックアップ・マイグレーションスクリプト
│
├─ main.py                 # アプリ起動エントリポイント
└─ README.md               # プロジェクト概要と機能要約
```

### ディレクトリ別役割一覧

| ディレクトリ | 役割概要 |
|--------------|-----------|
| `backend/`   | カメラ制御、スクリーン領域・深度管理、ボール追跡ロジック。UI と分離されたコア処理。 |
| `frontend/`  | PyQt6 による GUI 実装。領域設定、ゲーム操作、色設定などユーザー操作全般。 |
| `common/`    | ログ出力と汎用ユーティリティ関数。どこからでもインポート可能なヘルパー群。 |
| `tests/`     | 各モジュールの単体テスト。CI で自動実行される。 |
| `scripts/`   | 開発支援スクリプト（例：ログマイグレーション）。 |
| `main.py`    | アプリケーションの起動エントリポイント。 |

---  

## 2. ファイル別機能一覧（クラス / 関数）

### `backend/backend_core.py`

#### クラス: `BackendCore`
- スクリーン領域・深度ログのコア管理。
- 主なメソッド  
  - `set_screen_area(top_left, bottom_right)` ? 領域を JSON に保存。  
  - `get_screen_area()` ? 設定済み領域を取得（`None` 可能）。  
  - `load_screen_area()` ? ログから領域情報を復元。  
  - `set_screen_depth(depth)` ? 深度を JSON に保存。  
  - `load_screen_depth()` ? ログから深度情報を復元。  
  - `get_screen_depth()` ? 現在の深度（未設定時は `None`）。

---

### `backend/ball_tracker.py`

#### クラス: `BallTracker`（実装 `BallTrackerInterface`）
- ボール色設定、HSV 範囲での検出、ヒット座標取得・判定。
- **デフォルト最小面積** `min_area = 30`（UI から `set_min_area()` で変更可能）。  
- 主なメソッド  
  - `set_target_color(color)` ? 「赤」または「ピンク」の文字列で色を設定。  
  - `detect_ball(frame)` ? HSV フィルタと **最小面積フィルタ** を適用し、`(x, y, depth)` を返す。  
  - `get_hit_area(frame)` ? `detect_ball` のラッパー。  
  - `check_target_hit(frame)` ? 衝突判定ロジック。  
    - スクリーン領域内部かつ角度・距離条件でヒットを判断。  
    - `common/config.py` の `COLLISION_DEPTH_THRESHOLD`（0.15?m）以下になるまで「落下」状態を維持。  
  - `set_min_area(area)` ? 最小輪郭面積の設定。  
  - `set_hsv_limits(sat_low, sat_high, val_low, val_high)` ? HSV 上限・下限を更新。  
- 状態管理変数: `_last_center`, `_prev_center`, `_collision_state`（"none", "hit_front", "falling"）など。

---

### `backend/screen_manager.py`

#### クラス: `ScreenManager`（実装 `ScreenManagerInterface`）
- スクリーン領域を **4 点リスト** で保持し、レガシー API (`top_left`, `bottom_right`) にも対応。  
- ログ保存形式は JSON：`{"screen_area": [...], "screen_depth": ...}`。  
- 主なメソッド  
  - `set_screen_area(points)` ? 4 点リストで領域を設定し、`area_log.json` に保存。  
  - `set_screen_area_points(points)` ? 同上（別名ラッパー）。  
  - `set_screen_area_legacy(top_left, bottom_right)` ? 旧形式から自動変換して保存。  
  - `get_screen_area()` ? レガシー形式で `(top_left, bottom_right)` を返す。  
  - `get_screen_area_points()` ? 現在保持している 4 点リストを返す。  
  - `set_screen_depth(depth)` / `get_screen_depth()` ? 深度情報の保存・取得。  
  - `load_log()` ? **新旧フォーマット**（リスト形式または辞書形式）に対応し、`self.screen_area` と `self.screen_depth` を復元。  

---

### `common/config.py`

```python
# 共通設定ファイル

# OxGame 用フレームレート（約120fps）
OX_GAME_TARGET_FPS = 120
TARGET_FPS = OX_GAME_TARGET_FPS

# TrackTargetConfig 用フレームレート（約120fps）
TRACK_TARGET_CONFIG_FPS = 120

GRID_LINE_WIDTH = 20  # グリッド線幅（ピクセル）

# 衝突判定用深度閾値（メートル単位、スクリーン前面からの距離）
COLLISION_DEPTH_THRESHOLD = 0.15   # 例: 150mm

# 深度測定の有効範囲上限（mm）
MAX_VALID_DEPTH_MM = 5000   # 例: 5m までを有効とみなす


def timer_interval_ms(fps: int) -> int:
    """
    FPS からタイマー間隔 (ms) を計算します。
    最小 1 ms に丸め込み、整数で返却します。

    Args:
        fps: 目標フレームレート

    Returns:
        タイマーに渡すミリ秒数
    """
    if fps <= 0:
        return 1
    # round to nearest integer millisecond
    return max(1, int(round(1000 / fps)))
```

- `OX_GAME_TARGET_FPS` と `TARGET_FPS` は 120?FPS を基準。  
- `GRID_LINE_WIDTH = 20` により、`ox_game.py` のグリッド線が太く描画される。  
- `COLLISION_DEPTH_THRESHOLD` が衝突判定の深度閾値として `BallTracker.check_target_hit` で使用。  
- `timer_interval_ms(fps)` は UI タイマー間隔計算に利用。

---

### `frontend/ox_game.py`

#### 主な機能と変更点

- **FPS 表示**: ラベルは「`FPS: 120 (実測: xx.x)`」形式で、目標 FPS と実測 FPS を同時に表示。  
- **衝突検知ダイアログ**: `QMessageBox.exec()` によるモーダルウィンドウが表示され、トラッキングは一時停止。ユーザーが OK を押すと 1?秒遅延（`QTimer.singleShot(1000, ...)`）して再開。  
- **プレイヤー交代**: ヒット処理 `_process_hit` 内で自動的に行われ、別ダイアログは表示されない。  
- **衝突描画**: 衝突が検出されたフレームで青円（半径 50?px）を一度だけ描画し、`collision_shown` フラグで制御。再びヒットが無い限り同ターン内では描画されない。  
- **最初のヒット座標**: 小さな青円（半径 10?px）が固定表示され、ゲーム開始時の基準点として残る。  
- **デバッグ描画**: `debug` が有効な場合、検出されたボール位置を緑色矩形でハイライトし、深度情報をテキストで表示。衝突座標は青色テキストでも表示。  
- **グリッド線幅**: `common/config.py` の `GRID_LINE_WIDTH = 20` を使用して、3×3 グリッドの線が太く描画される。  
- **FPS 計算**: `QElapsedTimer` とフレームカウントで 1?秒ごとに実測 FPS を計算し、ラベルを更新。  

#### クラス構成（抜粋）

```python
class OxGame(QWidget):
    def __init__(self, camera_manager, screen_manager, ball_tracker):
        # UI 初期化、バックエンドコンポーネント取得、ログロード
        ...

    def _update_frame(self):
        # カメラフレーム取得 → ボール検出・衝突判定
        # QPainter でグリッド、マーカー、デバッグ情報を描画
        # ヒットがあれば _process_hit を呼び出し、プレイヤー交代処理へ
        ...

    def _show_collision_stop_message(self):
        # モーダル QMessageBox で衝突通知 → 1 秒遅延後に resume_tracking()
        ...
```

---

## 3. 補足情報

- **ログフォーマット**: `ScreenManager` は従来の `{ "screen_area": [...], "screen_depth": ... }` と、過去バージョンで使用されていたリスト形式（`[ { "points": [...] }, … ]`）の両方を読み込めます。  
- **UI からの設定変更**: `BallTracker.set_min_area()` および `BallTracker.set_hsv_limits()` により、最小面積や HSV の上下限をリアルタイムで調整可能です（設定は `tracked_ball` 辞書に保存され、`save_config()` で永続化）。  
- **衝突判定ロジック**: `BallTracker.check_target_hit()` は
  - ポリゴン内部判定 (`cv2.pointPolygonTest`)  
  - 角度変化とエッジ距離の組み合わせによるヒット推測  
  - 深度が `COLLISION_DEPTH_THRESHOLD` 以下になるまで「落下」状態を維持し、最終的に座標を返す。  

以上が現在のコードベースに基づく最新の機能説明一覧です。必要に応じてこの内容で `md_/現在の機能説明一覧_マークダウン_1115_v2.md` を上書きしてください。