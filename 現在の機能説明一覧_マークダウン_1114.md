以下が **現在の機能説明一覧_マークダウン.md** の最新版です。  
プロジェクト内の実装と設定に合わせて、特に FPS 関連の記述を修正しました。

---

# TTG プロジェクト ? ソースコード構造と機能一覧

---  

## 1. プロジェクトツリー（役割付き）

### ディレクトリ構造

```plaintext
ttg/
├─ backend/                # カメラ・スクリーン管理・ボール追跡のコアロジック
│   ├─ backend_core.py     # スクリーン領域と深度ログの中心処理
│   ├─ ball_tracker.py     # ボール色設定、検出、ヒット判定
│   ├─ camera_manager.py   # DepthAI カメラ接続・フレーム取得
│   ├─ external_api.py     # BallTracker を外部から取得できる API
│   ├─ interfaces.py       # 抽象インターフェース（Camera, BallTracker, ScreenManager）
│   └─ screen_manager.py   # スクリーン領域・深度情報の保存・取得
│
├─ frontend/               # ユーザーインタフェース層（PyQt6）
│   ├─ game_logic.py       # ゲームモード管理、スコア計算、勝利判定
│   ├─ main_window.py      # アプリ全体のメインウィンドウと操作ボタン
│   ├─ game_area.py        # カメラ映像上で領域設定を行う UI
│   ├─ ox_game.py          # OX（Tick & Cross）ゲーム UI とロジック連携
│   ├─ track_target_config.py  # ボール追跡対象の色・HSV 設定 UI
│   └─ track_target_viewer.py  # 追跡対象を映像上にハイライト表示する UI
│
├─ common/                 # 共通ユーティリティとロギング
│   ├─ logger.py           # ログフォルダ作成・JSON ログ書き込み
│   ├─ utils.py            # JSON I/O、座標検証・計算等のヘルパー関数
│   └─ config.py           # **設定定数とユーティリティ関数**（最新版参照）
│
├─ tests/                  # ユニットテスト（CI対応）
│   ├─ test_backend_logic.py
│   ├─ test_camera_manager.py
│   ├─ test_ball_tracker.py
│   ├─ test_ball_tracker_hit.py
│   └─ test_screen_manager.py
│
├─ scripts/
│   └─ migrate_logs.py     # ログファイルのバックアップ・マイグレーションスクリプト
│
├─ main.py                 # アプリ起動エントリポイント
└─ README.md               # プロジェクト概要と機能要約
```

### ディレクトリ別役割一覧

| ディレクトリ | 役割概要 |
|--------------|-----------|
| `backend/`   | カメラ制御、スクリーン領域・深度管理、ボール追跡ロジック。UI と分離されたコア処理。 |
| `frontend/`  | PyQt6 による GUI 実装。領域設定、ゲーム操作、色設定などユーザー操作全般。 |
| `common/`    | ログ出力と汎用ユーティリティ関数。どこからでもインポート可能なヘルパー群。 |
| `tests/`     | 各モジュールの単体テスト。CI で自動実行される。 |
| `scripts/`   | 開発支援スクリプド（例：ログマイグレーション）。 |
| `main.py`    | アプリケーションの起動エントリポイント。 |

---  

## 2. ファイル別機能一覧（クラス / 関数）

### `backend/backend_core.py`

#### クラス: `BackendCore`
- スクリーン領域・深度ログのコア管理。  
- 主なメソッド: `set_screen_area`, `get_screen_area`, `load_screen_area` など。

---  

### `backend/ball_tracker.py`

#### クラス: `BallTracker`（実装 `BallTrackerInterface`）
- ボール色設定、HSV 範囲での検出、ヒット座標取得・判定。  
- 主なメソッド: `set_target_color`, `detect_ball`, `get_hit_area`, `check_target_hit`。

---  

### `backend/camera_manager.py`

#### クラス: `CameraManager`（実装 `CameraInterface`）
- DepthAI カメラの初期化、フレーム取得、FPS 設定、クローズ処理。  
- 主なメソッド: `initialize_camera`, `get_frame`, `close_camera`。

---  

### `backend/external_api.py`

#### モジュール関数・変数
- `_ball_tracker`（グローバルインスタンス）  
- `set_ball_tracker(ball_tracker)`, `get_target_position()`。

---  

### `backend/interfaces.py`

#### 抽象クラス群
- `CameraInterface`, `BallTrackerInterface`, `ScreenManagerInterface`.

---  

### `backend/screen_manager.py`

#### クラス: `ScreenManager`
- スクリーン領域（4点リスト）と深度情報の保存・取得、ログ入出力を担当。

---  

## `common/config.py` **（最新版）**

```python
# common/config.py
"""
共通設定ファイル

- 各 UI の目標フレームレート (FPS)
- タイマー間隔 (ms) を FPS から計算するユーティリティ関数
"""

# OxGame 用フレームレート（約120fps）
OX_GAME_TARGET_FPS = 120
TARGET_FPS = OX_GAME_TARGET_FPS

# TrackTargetConfig 用フレームレート（約120fps）※将来的に別設定へ拡張可
TRACK_TARGET_CONFIG_FPS = 120

def timer_interval_ms(fps: int) -> int:
    """
    FPS からタイマー間隔 (ms) を計算します。
    最小 1 ms に丸め込み、整数で返却します。

    Args:
        fps: 目標フレームレート

    Returns:
        タイマーに渡すミリ秒数
    """
    if fps <= 0:
        return 1
    # round to nearest integer millisecond
    return max(1, int(round(1000 / fps)))
```

- **目的**: フレームレートとタイマー間隔を一元管理し、将来的に設定画面や JSON 設定から変更できる基盤を提供。

---  

## `frontend/ox_game.py` **（最新版）**

### 主な変更点
1. **FPS 表示ラベルの追加**  
   ```python
   self.fps_label = QLabel(self)
   self.fps_label.setText(f"FPS: {OX_GAME_TARGET_FPS}")
   ```
2. **実測 FPS 計算用変数**  
   ```python
   self.frame_count = 0
   self.last_time = QElapsedTimer()
   self.last_time.start()
   ```
3. **レイアウトにラベルを組み込み**  
   `layout.addWidget(self.fps_label)` を追加し、左上に固定表示。
4. **`_update_frame` の末尾で実測 FPS を計算・更新**  
   ```python
   self.frame_count += 1
   elapsed = self.last_time.elapsed()
   if elapsed >= 1000:          # 1秒ごとにFPSを計算
       actual_fps = self.frame_count * 1000.0 / elapsed
       self.fps_label.setText(
           f"FPS: {OX_GAME_TARGET_FPS} (実測: {actual_fps:.1f})"
       )
       self.frame_count = 0
       self.last_time.restart()
   ```

### 効果
- **固定 FPS**（120）と **実測 FPS** がリアルタイムでウィンドウ左上に表示され、パフォーマンスの目視確認が可能。  
- `timer_interval_ms(OX_GAME_TARGET_FPS)` により内部タイマーは約 8?ms（?125?fps）で動作し、実測値と比較できる。

---  

## `frontend/game_area.py`  
（変更なし）※既存機能はそのまま維持。  

---  

## `frontend/main_window.py`, `frontend/track_target_config.py`, `frontend/track_target_viewer.py`  
（変更なし）※UI の全体構成は変わらず、FPS 表示は `OxGame` に限定。

---  

## 3. 完成したドキュメントの利用イメージ

### 1?? 新しいチャットへ貼り付け  
この Markdown 全体をコピーして LLM に送信すれば、プロジェクト構造・各コンポーネントの役割・最新実装情報が一目で把握できます。

### 2?? コードレビューや設計議論  
ディレクトリ別概要と機能一覧を参照しながら、変更対象ファイルや依存関係を迅速に特定可能です。特に `common/config.py` と `frontend/ox_game.py` の新規項目は FPS 管理の中心となります。

### 3?? 実装・改修時のナビゲーション  
- **FPS 関連**: `common/config.py` → 定数 / ユーティリティ関数。  
- **実測 FPS 表示**: `frontend/ox_game.py` のラベルと計算ロジック。  
- **設定拡張**: 将来的に UI から `TARGET_FPS` を変更したい場合は、`common/config.py` に JSON 読み込みロジックを追加すれば容易です。

---  

以上が更新された **現在の機能説明一覧_マークダウン.md** の内容です。  
ご確認の上、ファイルを書き換えていただければ完了です。